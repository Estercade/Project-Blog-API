const { PrismaClient } = require("@prisma/client");
const prisma = new PrismaClient();

async function createUser(query) {
  const match = await prisma.user.findUnique({
    where: {
      username: query.username,
    }
  });
  // return "taken" if username is already taken
  if (match) {
    return "taken";
  }
  const user = await prisma.user.create({
    data: {
      username: query.username,
      password: query.password,
      email: query.email,
    },
    select: {
      username: true,
      email: true,
      role: true
    }
  });
  return user;
}

async function getAllUsers(query) {
  const users = await prisma.user.findMany({
    select: {
      username: true,
      _count: {
        select: { 
          posts: true,
          comments: true,
        }
      },
      role: true,
    },
    orderBy: query.sort
  });
  return users;
}

async function getUserByUsername(query) {
  const user = await prisma.user.findUnique({
    where: {
      username: query.username
    },
    select: {
      username: true,
      posts: {
        where: {
          published: true
        },
        select: {
          id: true,
          title: true,
          content: true,
          publishedAt: true,
          lastEditedAt: true,
          author: {
            select: {
              username: true
            }
          },
          totalRating: true,
          _count: {
            select: { comments: true },
          },
        }
      },
      comments: {
        select: {
          id: true,
          content: true,
          postedAt: true,
          lastEditedAt: true,
          author: {
            select: {
              username: true
            }
          },
          post: {
            select: {
              id: true,
              title: true,
            }
          },
        }
      },
    }
  });
  return user;
}

async function updateUser(query) {
  // check if username is already taken
  const tempUser = await prisma.user.findUnique({
    where: {
      username: query.username
    }
  })
  // return "taken" string if username is already taken 
  // and current userId does not match the userId associated with that username
  if (tempUser && tempUser.id !== query.userId) {
    return "taken";
  }
  const user = await prisma.user.update({
    where: {
      username: query.username,
    },
    data: {
      username: query.username,
      password: query.password,
      email: query.email
    },
    select: {
      username: true,
      email: true,
      role: true
    }
  });
  return user;
}

async function deleteUser(targetUserId) {
  await prisma.user.delete({
    where: {
      id: targetUserId
    }
  });
}

async function getPostsByUsername(query) {
  const [{ posts }] = await prisma.user.findMany({
    where: {
      username: query.username
    },
    select: {
      posts: {
        where: {
          published: true
        },
        select: {
          id: true,
          title: true,
          content: true,
          published: true,
          publishedAt: true,
          lastEditedAt: true,
          author: {
            select: {
              username: true,
            }
          },
          totalRating: true,
          _count: {
            select: { comments: true },
          },
        },
        orderBy: query.sort
      }
    }
  })
  return posts;
}

async function getCommentsByUsername(query) {
  const [{ comments }] = await prisma.user.findMany({
    where: {
      username: query.username
    },
    select: {
      username: true,
      comments: {
        select: {
          id: true,
          content: true,
          postedAt: true,
          lastEditedAt: true,
          author: {
            select: {
              username: true
            }
          },
          post: {
            select: {
              id: true,
              title: true,
            }
          },
        },
        orderBy: query.sort
      }
    }
  })
  return comments;
}

async function getDraftsByUsername(query) {
  // retrieve target user
  const user = await prisma.user.findUnique({
    where: {
      username: query.username
    }
  })
  // if current userId does not match the userId associated 
  // with that username, return "forbidden" string
  if (user.id !== query.userId) {
    return "forbidden";
  }
  const [drafts] = await prisma.user.findMany({
    where: {
      username: query.username
    },
    select: {
      posts: {
        where: {
          published: false
        },
        select: {
          id: true,
          title: true,
          content: true,
          published: true,
          createdAt: true,
          lastEditedAt: true,
          author: {
            select: {
              username: true,
            }
          },
          totalRating: true,
          _count: {
            select: { comments: true },
          },
        },
        orderBy: query.sort
      }
    }
  })
  return drafts.posts;
}

module.exports = {
  createUser,
  getAllUsers,
  getUserByUsername,
  updateUser,
  deleteUser,
  getPostsByUsername,
  getCommentsByUsername,
  getDraftsByUsername
}