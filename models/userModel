const { PrismaClient } = require("@prisma/client");
const prisma = new PrismaClient();

async function createUser(query) {
  const user = await prisma.user.create({
    data: {
      username: query.username,
      password: query.password,
      email: query.email,
    },
    select: {
      username: true,
      email: true
    }
  });
  return user;
}

async function getAllUsers() {
  const users = await prisma.user.findMany();
  return users;
}

async function getUserByUsername(targetUsername) {
  const user = await prisma.user.findUnique({
    where: {
      username: targetUsername
    },
    select: {
      username: true,
      posts: {
        where: {
          published: true
        },
        select: {
          id: true,
          title: true,
          content: true,
          publishedAt: true,
          author: {
            select: {
              username: true
            }
          },
          averageRating: true,
          _count: {
            select: { comments: true },
          },
        }
      },
      comments: {
        select: {
          id: true,
          content: true,
          posted: true,
          postId: true,
          author: {
            select: {
              username: true
            }
          },
        }
      },
    }
  });
  return user;
}

async function getUserById(targetUserId) {
  const user = await prisma.user.findUnique({
    where: {
      id: targetUserId
    },
    select: {
      username: true,
      email: true,
      posts: true,
      comments: true,
    }
  });
}

async function updateUser(targetUsername, query) {
  const user = await prisma.user.update({
    where: {
      username: targetUsername,
    },
    data: {
      username: query.username,
      password: query.password,
      email: query.email
    }
  });
  return user;
}

async function deleteUser(targetUserId) {
  await prisma.user.delete({
    where: {
      id: targetUserId
    }
  });
}

async function getPostsByUsername(targetUsername) {
  const [{ posts }] = await prisma.user.findMany({
    where: {
      username: targetUsername
    },
    select: {
      posts: true,
    }
  })
  return posts;
}

async function getCommentsByUsername(targetUsername) {
  const [{ comments }] = await prisma.user.findMany({
    where: {
      username: targetUsername
    },
    select: {
      username: true,
      comments: true,
    }
  })
  return comments;
}

module.exports = {
  createUser,
  getAllUsers,
  getUserByUsername,
  getUserById,
  updateUser,
  deleteUser,
  getPostsByUsername,
  getCommentsByUsername
}